<!DOCTYPE html>
<html lang="bn" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diganta - ‡¶™‡ßç‡¶∞‡¶ø‡¶Æ‡¶ø‡ßü‡¶æ‡¶Æ ‡¶á-‡¶¨‡ßÅ‡¶ï ‡¶∏‡ßç‡¶ü‡ßã‡¶∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; transition: background-color 0.3s; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .tab-active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); }
        :root { --primary-color: #059669; }
        
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-confirmed { background-color: #dcfce7; color: #166534; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }
        
        .file-input-label {
            border: 2px dashed #e2e8f0;
            padding: 1rem;
            border-radius: 1rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.2s;
        }
        .file-input-label:hover { border-color: var(--primary-color); background-color: #f0fdf4; }
    </style>
</head>
<body class="min-h-full flex flex-col text-slate-800">

    <div id="app-root">
        <!-- Loading Spinner -->
        <div id="global-loader" class="fixed inset-0 z-[200] bg-white flex items-center justify-center">
            <div class="flex flex-col items-center gap-4">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-emerald-600"></div>
                <p class="text-xl font-bold text-emerald-700">Diganta ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                <p class="text-xs text-slate-400">‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶®‡ßá‡¶ï‡¶ï‡ßç‡¶∑‡¶£ ‡¶≤‡ßã‡¶° ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>
        </div>

        <!-- Navigation -->
        <header class="sticky top-0 z-50 glass-effect border-b border-slate-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2 cursor-pointer" onclick="navigateTo('home')">
                    <span class="text-3xl">üìñ</span>
                    <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-blue-600">Diganta</h1>
                </div>
                <div class="flex items-center gap-3">
                    <a href="tel:01715247588" class="hidden md:flex items-center gap-2 font-bold text-slate-600 hover:text-emerald-600 transition">
                        <span>üìû</span> 01715247588
                    </a>
                    <button onclick="toggleAdmin()" class="bg-slate-100 hover:bg-slate-200 p-2 rounded-full transition">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div id="content-area"></div>

        <!-- Order Modal -->
        <div id="order-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeOrderModal()"></div>
            <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                    <h3 class="text-xl font-bold">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                    <button onclick="closeOrderModal()" class="text-slate-400 hover:text-red-500 text-2xl">√ó</button>
                </div>
                <div class="p-6 overflow-y-auto custom-scroll">
                    <div id="order-book-summary" class="mb-6 p-4 bg-emerald-50 rounded-2xl flex items-center gap-4 border border-emerald-100"></div>
                    <div class="mb-6">
                        <p class="text-sm font-bold text-slate-500 mb-2 uppercase tracking-wider">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø)</p>
                        <div class="bg-pink-50 p-4 rounded-2xl border border-pink-100 text-center">
                            <p class="text-pink-700 font-bold text-lg mb-1">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞: <span id="payment-bkash">01912125156</span></p>
                            <p class="text-pink-600 text-xs italic">‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá TrxID ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡¶ø‡¶®</p>
                        </div>
                    </div>
                    <form id="order-form" class="space-y-4">
                        <input type="hidden" id="order-book-id">
                        <input type="text" id="cust-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ" required class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                        <input type="tel" id="cust-phone" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞" required class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                        <textarea id="cust-address" placeholder="‡¶™‡ßÅ‡¶∞‡ßã ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ" required class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 h-20"></textarea>
                        <input type="text" id="cust-trx" placeholder="‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ TrxID" required class="w-full border border-pink-200 p-3 rounded-xl outline-none focus:ring-2 focus:ring-pink-500 uppercase font-bold text-pink-700">
                        <button type="submit" id="order-submit-btn" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-bold text-lg hover:bg-emerald-700 shadow-lg transition transform active:scale-95">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Admin Access -->
        <div id="admin-gate" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-md" onclick="toggleAdmin()"></div>
            <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl relative z-10 p-8 text-center">
                <span class="text-5xl mb-4 block">üîê</span>
                <h3 class="text-2xl font-bold mb-2">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂</h3>
                <input type="password" id="admin-pass-input" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (admin123)" class="w-full border p-4 rounded-2xl mb-4 text-center outline-none">
                <button onclick="accessAdmin()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold hover:bg-slate-800 transition">‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // GitHub Compatibility: Fallback to manual config if __firebase_config is not defined
        const manualFirebaseConfig = {
            apiKey: "AIzaSyBHFsTRQT1eopfz8NG5ux__0QKgKCnoXOE",
            authDomain: "support-94add.firebaseapp.com",
            projectId: "support-94add",
            storageBucket: "support-94add.firebasestorage.app",
            messagingSenderId: "442252148032",
            appId: "1:442252148032:web:d837b86837d67ec0368ea5"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'diganta-store-v3';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State attached to window for global access
        window.state = {
            user: null,
            books: [],
            orders: [],
            config: {
                bannerTitle: "‡¶ú‡ßç‡¶û‡¶æ‡¶®‡ßá‡¶∞ ‡¶≠‡¶æ‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Æ‡ßÅ‡¶†‡ßã‡¶Ø‡¶º",
                bannerSubtitle: "‡¶∏‡ßá‡¶∞‡¶æ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶á-‡¶¨‡ßÅ‡¶ï ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®",
                bannerImage: "https://images.unsplash.com/photo-1512820790803-83ca734da794?w=1200",
                primaryColor: "#059669",
                bkash: "01912125156",
            },
            currentPage: 'home',
            isAdmin: false,
            adminActiveTab: 'books',
            tempFiles: { main: '', gallery: [], preview: [], pdf: '' },
            selectedBook: null
        };

        const init = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, user => { 
                    if(user) { 
                        window.state.user = user; 
                        setupListeners(); 
                    } 
                });
            } catch (err) {
                console.error("Firebase Auth Error:", err);
                document.getElementById('global-loader').innerHTML = `
                    <div class="p-8 bg-white rounded-3xl text-center shadow-xl border border-red-100">
                        <p class="text-red-500 font-bold">‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡ßá ‡¶®‡¶æ!</p>
                        <p class="text-xs text-slate-400 mt-2">${err.message}</p>
                    </div>
                `;
            }
        };

        const setupListeners = () => {
            // Updated Path: artifacts/{appId}/public/data/settings/siteConfig (6 segments)
            const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'siteConfig');
            onSnapshot(configRef, d => { 
                if(d.exists()) { 
                    window.state.config = {...window.state.config, ...d.data()}; 
                    document.documentElement.style.setProperty('--primary-color', window.state.config.primaryColor); 
                } 
                render(); 
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'books'), s => { 
                window.state.books = s.docs.map(d => ({id: d.id, ...d.data()})); 
                render(); 
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), s => { 
                window.state.orders = s.docs.map(d => ({id: d.id, ...d.data()})); 
                if(window.state.isAdmin) render(); 
            });
            
            setTimeout(() => {
                const loader = document.getElementById('global-loader');
                if (loader) loader.style.display = 'none';
            }, 800);
        };

        // File to Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        window.handleFileSelect = async (e, type, index = -1) => {
            const files = e.target.files;
            if(!files.length) return;
            const status = e.target.parentElement.querySelector('.file-status');
            if(status) status.innerText = "‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

            try {
                if(type === 'main') window.state.tempFiles.main = await toBase64(files[0]);
                else if(type === 'gallery') {
                    for(let f of files) window.state.tempFiles.gallery.push(await toBase64(f));
                }
                else if(type === 'preview') {
                    for(let f of files) window.state.tempFiles.preview.push(await toBase64(f));
                }
                else if(type === 'pdf') window.state.tempFiles.pdf = await toBase64(files[0]);

                if(status) {
                    status.innerText = "‚úÖ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∞‡ßá‡¶°‡¶ø";
                    status.classList.add('text-emerald-600');
                }
            } catch(err) {
                alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                if(status) status.innerText = "‚ùå ‡¶è‡¶∞‡¶∞";
            }
        };

        window.navigateTo = (p, id = null) => { 
            window.state.currentPage = p; 
            window.state.selectedBook = id ? window.state.books.find(b => b.id === id) : null; 
            window.scrollTo(0,0); 
            render(); 
        };

        const render = () => {
            const root = document.getElementById('content-area');
            if (!root) return;
            if (window.state.currentPage === 'home') root.innerHTML = renderHome();
            else if (window.state.currentPage === 'detail') root.innerHTML = renderDetail();
            else if (window.state.currentPage === 'admin') root.innerHTML = renderAdmin();
        };

        const renderHome = () => {
            const featured = window.state.books[0];
            return `
                <section class="relative bg-slate-900 h-[450px]">
                    <img src="${window.state.config.bannerImage}" class="w-full h-full object-cover opacity-40">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center text-white px-4">
                        <h2 class="text-4xl md:text-6xl font-black mb-4">${window.state.config.bannerTitle}</h2>
                        <p class="text-xl md:text-2xl opacity-90">${window.state.config.bannerSubtitle}</p>
                    </div>
                </section>
                <div class="max-w-7xl mx-auto px-4 -mt-20 relative z-10 pb-20">
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                        ${window.state.books.map(b => `
                            <div onclick="navigateTo('detail', '${b.id}')" class="bg-white p-3 rounded-3xl shadow-lg hover:shadow-2xl transition cursor-pointer group">
                                <div class="aspect-[3/4] rounded-2xl overflow-hidden bg-slate-100 mb-4">
                                    <img src="${b.images?.[0] || ''}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                                </div>
                                <h4 class="font-bold text-slate-800 truncate">${b.title}</h4>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-emerald-600 font-black">‡ß≥${b.offerPrice}</span>
                                    <span class="text-[10px] bg-slate-100 px-2 py-1 rounded">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${window.state.books.length === 0 ? '<div class="text-center py-20 bg-white rounded-3xl text-slate-300 font-bold border shadow-inner">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶á ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø</div>' : ''}
                </div>
            `;
        };

        const renderDetail = () => {
            const b = window.state.selectedBook;
            if (!b) return '<div class="p-20 text-center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>';
            return `
                <div class="max-w-6xl mx-auto px-4 py-10">
                    <button onclick="navigateTo('home')" class="mb-8 font-bold text-slate-500 hover:text-emerald-600 flex items-center gap-2">‚¨Ö ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                        <div class="lg:col-span-5 space-y-4">
                            <div class="rounded-3xl overflow-hidden shadow-2xl aspect-[3/4] bg-slate-100">
                                <img id="detail-main-img" src="${b.images?.[0]}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex gap-2 overflow-x-auto pb-2 custom-scroll">
                                ${b.images?.map(img => `<img onclick="document.getElementById('detail-main-img').src='${img}'" src="${img}" class="w-16 h-20 object-cover rounded-xl cursor-pointer border-2 border-transparent hover:border-emerald-500 bg-white">`).join('')}
                            </div>
                        </div>
                        <div class="lg:col-span-7">
                            <h2 class="text-4xl font-black mb-2">${b.title}</h2>
                            <p class="text-slate-500 text-xl mb-6">${b.author}</p>
                            <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 flex items-center justify-between mb-8">
                                <div>
                                    <p class="text-slate-400 line-through">‡ß≥${b.price}</p>
                                    <p class="text-5xl font-black text-emerald-600">‡ß≥${b.offerPrice}</p>
                                </div>
                                <span class="bg-emerald-600 text-white px-4 py-1 rounded-full text-sm font-bold">‡¶á‡¶®-‡¶∏‡ßç‡¶ü‡¶ï</span>
                            </div>
                            <div class="border-b flex gap-6 mb-6">
                                <button onclick="tabSwitch('summary')" class="pb-2 font-bold tab-btn tab-active" id="btn-sum">‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</button>
                                <button onclick="tabSwitch('preview')" class="pb-2 font-bold tab-btn text-slate-400" id="btn-pre">‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶™‡¶æ‡¶§‡¶æ</button>
                            </div>
                            <div id="tab-content" class="text-slate-600 leading-relaxed text-lg min-h-[150px]">
                                ${b.summary}
                            </div>
                            <button onclick="openOrderModal('${b.id}')" class="mt-10 w-full bg-slate-900 text-white py-6 rounded-3xl font-black text-xl hover:bg-emerald-600 shadow-xl transition-all">üõí ‡¶è‡¶ñ‡¶®‡¶á ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAdmin = () => {
            const revenue = window.state.orders.filter(o => o.status === 'confirmed').reduce((a,c) => a + (window.state.books.find(b=>b.id===c.bookId)?.offerPrice || 0), 0);
            return `
                <div class="max-w-7xl mx-auto px-4 py-10">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-3xl font-black">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
                        <button onclick="logoutAdmin()" class="text-red-500 font-bold underline">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-3 flex lg:flex-col gap-2 overflow-x-auto pb-4">
                            <button onclick="toggleAdminTab('books')" class="w-full text-left p-4 rounded-2xl border font-bold ${window.state.adminActiveTab==='books'?'bg-emerald-600 text-white':'bg-white'} transition">üìö ‡¶¨‡¶á‡¶∏‡¶Æ‡ßÇ‡¶π</button>
                            <button onclick="toggleAdminTab('orders')" class="w-full text-left p-4 rounded-2xl border font-bold ${window.state.adminActiveTab==='orders'?'bg-emerald-600 text-white':'bg-white'} transition">üì¶ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶∏‡¶Æ‡ßÇ‡¶π</button>
                            <button onclick="toggleAdminTab('settings')" class="w-full text-left p-4 rounded-2xl border font-bold ${window.state.adminActiveTab==='settings'?'bg-emerald-600 text-white':'bg-white'} transition">üé® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
                        </div>
                        <div id="admin-view-container" class="lg:col-span-9 bg-white p-8 rounded-[2.5rem] border shadow-xl min-h-[500px]">
                            ${window.state.adminActiveTab==='books' ? renderAdminBooks() : window.state.adminActiveTab==='orders' ? renderAdminOrders(revenue) : window.state.adminActiveTab === 'settings' ? renderAdminSettings() : ''}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAdminBooks = () => `
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">‡¶¨‡¶á ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                <button onclick="toggleAdminTab('form')" class="bg-emerald-600 text-white px-5 py-2 rounded-xl font-bold hover:bg-emerald-700">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á</button>
            </div>
            <div class="space-y-4">
                ${window.state.books.map(b => `
                    <div class="flex items-center gap-4 p-4 border rounded-2xl hover:bg-slate-50 transition">
                        <img src="${b.images?.[0] || ''}" class="w-16 h-20 object-cover rounded-lg bg-slate-100">
                        <div class="flex-grow"><h4 class="font-bold">${b.title}</h4><p class="text-xs text-slate-400">‡ß≥${b.offerPrice}</p></div>
                        <button onclick="editBook('${b.id}')" class="text-blue-500 font-bold px-3">‡¶è‡¶°‡¶ø‡¶ü</button>
                        <button onclick="deleteBookItem('${b.id}')" class="text-red-500 font-bold px-3">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                    </div>
                `).join('')}
                ${window.state.books.length === 0 ? '<p class="text-center text-slate-400 py-10">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶á ‡¶®‡ßá‡¶á</p>' : ''}
            </div>
        `;

        const renderAdminOrders = (rev) => `
            <div class="flex items-center gap-4 mb-8">
                <div class="flex-grow p-4 bg-emerald-50 border border-emerald-100 rounded-3xl text-center">
                    <p class="text-xs text-emerald-600 font-bold uppercase">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø</p>
                    <p class="text-2xl font-black text-emerald-700">‡ß≥ ${rev}</p>
                </div>
                <div class="flex-grow p-4 bg-slate-50 border rounded-3xl text-center">
                    <p class="text-xs text-slate-400 font-bold uppercase">‡¶Æ‡ßã‡¶ü ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞</p>
                    <p class="text-2xl font-black">${window.state.orders.length}</p>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="p-3">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</th><th class="p-3">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</th><th class="p-3">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th><th class="p-3">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>
                    </thead>
                    <tbody>
                        ${window.state.orders.map(o => {
                            const book = window.state.books.find(b=>b.id===o.bookId);
                            const cur = o.status || 'pending';
                            return `
                                <tr class="border-b hover:bg-slate-50">
                                    <td class="p-3"><span class="font-bold text-slate-700">${book?.title||'‡¶¨‡¶á ‡¶®‡¶æ‡¶á'}</span><br><span class="text-[10px] text-slate-400">${o.name} | ${o.phone}</span></td>
                                    <td class="p-3 font-mono font-bold text-pink-600">${o.trxId}</td>
                                    <td class="p-3">
                                        <select onchange="updateOrderStatus('${o.id}', this.value)" class="p-1 rounded text-[10px] font-bold ${cur==='pending'?'status-pending':cur==='confirmed'?'status-confirmed':'status-cancelled'}">
                                            <option value="pending" ${cur==='pending'?'selected':''}>‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç</option>
                                            <option value="confirmed" ${cur==='confirmed'?'selected':''}>‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ</option>
                                            <option value="cancelled" ${cur==='cancelled'?'selected':''}>‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</option>
                                        </select>
                                    </td>
                                    <td class="p-3 text-right"><button onclick="deleteOrder('${o.id}')" class="text-red-400 hover:text-red-600">‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        const renderAdminSettings = () => `
            <div class="space-y-6">
                <h3 class="text-xl font-bold">‡¶•‡¶ø‡¶Æ ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤</label>
                        <input type="text" id="s-title" value="${window.state.config.bannerTitle}" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶¨-‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤</label>
                        <input type="text" id="s-sub" value="${window.state.config.bannerSubtitle}" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div class="col-span-full">
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú URL</label>
                        <input type="text" id="s-banner" value="${window.state.config.bannerImage}" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                        <input type="text" id="s-bkash" value="${window.state.config.bkash}" class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞</label>
                        <input type="color" id="s-color" value="${window.state.config.primaryColor}" class="w-full h-12 rounded-xl cursor-pointer">
                    </div>
                </div>
                <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        `;

        window.renderAdminForm = () => {
            const b = window.state.tempEditBook || {};
            return `
                <div class="space-y-8">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">${b.id ? '‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶°‡¶ø‡¶ü' : '‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶á ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®'}</h3>
                        <button onclick="toggleAdminTab('books')" class="text-slate-400 font-bold">X</button>
                    </div>
                    <form id="book-data-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="f-id" value="${b.id || ''}">
                        <div class="md:col-span-2">
                            <input type="text" id="f-title" value="${b.title || ''}" placeholder="‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ" required class="w-full border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <input type="text" id="f-author" value="${b.author || ''}" placeholder="‡¶≤‡ßá‡¶ñ‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" required class="border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="f-price" value="${b.price || ''}" placeholder="‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" required class="border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500">
                            <input type="number" id="f-offer" value="${b.offerPrice || ''}" placeholder="‡¶Ö‡¶´‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø" required class="border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <textarea id="f-summary" placeholder="‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ" required class="md:col-span-2 border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 h-32">${b.summary || ''}</textarea>
                        
                        <div class="space-y-4 md:col-span-2 border-t pt-6">
                            <h4 class="font-bold text-slate-500">‡¶Æ‡¶ø‡¶°‡¶ø‡ßü‡¶æ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° (‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="file-input-label">
                                    <span class="text-xs font-bold mb-2">‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶´‡¶ü‡ßã (‡ßß‡¶ü‡¶ø)</span>
                                    <input type="file" accept="image/*" onchange="handleFileSelect(event, 'main')" class="hidden">
                                    <span class="file-status text-[10px] text-slate-400">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                                </label>
                                <label class="file-input-label">
                                    <span class="text-xs font-bold mb-2">‡¶ó‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶∞‡¶ø ‡¶´‡¶ü‡ßã (‡ß´‡¶ü‡¶ø ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§)</span>
                                    <input type="file" accept="image/*" multiple onchange="handleFileSelect(event, 'gallery')" class="hidden">
                                    <span class="file-status text-[10px] text-slate-400">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                                </label>
                                <label class="file-input-label">
                                    <span class="text-xs font-bold mb-2">‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶™‡¶æ‡¶§‡¶æ (‡¶õ‡¶¨‡¶ø)</span>
                                    <input type="file" accept="image/*" multiple onchange="handleFileSelect(event, 'preview')" class="hidden">
                                    <span class="file-status text-[10px] text-slate-400">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                                </label>
                                <label class="file-input-label">
                                    <span class="text-xs font-bold mb-2">‡¶¨‡¶á‡ßü‡ßá‡¶∞ PDF ‡¶´‡¶æ‡¶á‡¶≤</span>
                                    <input type="file" accept=".pdf" onchange="handleFileSelect(event, 'pdf')" class="hidden">
                                    <span class="file-status text-[10px] text-slate-400">‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" id="book-save-btn" class="md:col-span-2 bg-emerald-600 text-white py-5 rounded-[2rem] font-black text-xl hover:bg-emerald-700 shadow-xl transition-all">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </form>
                </div>
            `;
        };

        // UI Globals
        window.toggleAdmin = () => {
            const el = document.getElementById('admin-gate');
            if (el) el.classList.toggle('hidden');
        };

        window.accessAdmin = () => {
            const input = document.getElementById('admin-pass-input');
            if(input && input.value === 'admin123') { 
                window.state.isAdmin = true; 
                navigateTo('admin'); 
                toggleAdmin(); 
            } else {
                alert('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!'); 
            }
        };

        window.logoutAdmin = () => {
            window.state.isAdmin = false;
            navigateTo('home');
        };

        window.toggleAdminTab = (t) => { 
            window.state.adminActiveTab = t; 
            const container = document.getElementById('admin-view-container');
            if(t === 'form') {
                if(container) container.innerHTML = renderAdminForm();
            } else {
                render();
                window.state.tempFiles = { main: '', gallery: [], preview: [], pdf: '' };
                window.state.tempEditBook = null;
            }
        };

        window.tabSwitch = (t) => {
            const root = document.getElementById('tab-content');
            const b1 = document.getElementById('btn-sum');
            const b2 = document.getElementById('btn-pre');
            if (!window.state.selectedBook) return;
            if(t === 'summary') { 
                if(root) root.innerHTML = window.state.selectedBook.summary; 
                b1?.classList.add('tab-active'); 
                b2?.classList.remove('tab-active'); 
                b2?.classList.add('text-slate-400'); 
            }
            else { 
                if(root) root.innerHTML = `<div class="grid grid-cols-2 gap-4">${window.state.selectedBook.previewPages?.map(img => `<img src="${img}" class="w-full border rounded-xl shadow-sm">`).join('') || '‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶æ‡¶§‡¶æ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡ßá‡¶á'}</div>`; 
                b2?.classList.add('tab-active'); 
                b1?.classList.remove('tab-active'); 
                b1?.classList.add('text-slate-400'); 
            }
        };

        window.openOrderModal = (id) => {
            const b = window.state.books.find(x=>x.id===id);
            const bookIdInput = document.getElementById('order-book-id');
            const summaryEl = document.getElementById('order-book-summary');
            const modal = document.getElementById('order-modal');
            if(bookIdInput) bookIdInput.value = id;
            if(summaryEl) summaryEl.innerHTML = `<img src="${b?.images?.[0] || ''}" class="w-12 h-16 object-cover rounded shadow bg-slate-100"><div><p class="font-bold text-slate-800 leading-tight">${b?.title || ''}</p><p class="text-emerald-600 font-black">‡ß≥ ${b?.offerPrice || 0}</p></div>`;
            const bkashEl = document.getElementById('payment-bkash');
            if(bkashEl) bkashEl.innerText = window.state.config.bkash;
            if(modal) modal.classList.remove('hidden');
        };

        window.closeOrderModal = () => {
            const modal = document.getElementById('order-modal');
            if(modal) modal.classList.add('hidden');
        };

        window.editBook = (id) => { 
            window.state.tempEditBook = window.state.books.find(b=>b.id===id); 
            toggleAdminTab('form'); 
        };

        window.deleteBookItem = async (id) => { 
            if(confirm('‡¶¨‡¶á‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'books', id)); 
            }
        };

        window.deleteOrder = async (id) => { 
            if(confirm('‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id)); 
            }
        };

        window.updateOrderStatus = async (id, status) => { 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id), { status }); 
        };

        window.saveSettings = async () => {
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'siteConfig');
            try {
                await setDoc(ref, {
                    bannerTitle: document.getElementById('s-title').value,
                    bannerSubtitle: document.getElementById('s-sub').value,
                    bannerImage: document.getElementById('s-banner').value,
                    primaryColor: document.getElementById('s-color').value,
                    bkash: document.getElementById('s-bkash').value
                });
                alert('‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
            } catch(err) { alert(err.message); }
        };

        // Document level event handling for dynamic forms
        document.addEventListener('submit', async (e) => {
            if(e.target.id === 'book-data-form') {
                e.preventDefault();
                const btn = document.getElementById('book-save-btn');
                if(btn) { btn.disabled = true; btn.innerText = "‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."; }
                const id = document.getElementById('f-id').value;
                const bookData = {
                    title: document.getElementById('f-title').value,
                    author: document.getElementById('f-author').value,
                    price: Number(document.getElementById('f-price').value),
                    offerPrice: Number(document.getElementById('f-offer').value),
                    summary: document.getElementById('f-summary').value,
                    updatedAt: serverTimestamp()
                };

                const existing = window.state.tempEditBook || {};
                bookData.images = window.state.tempFiles.main ? [window.state.tempFiles.main] : (existing.images?.slice(0,1) || []);
                if(window.state.tempFiles.gallery.length) bookData.images = [bookData.images[0], ...window.state.tempFiles.gallery];
                else if(existing.images) bookData.images = existing.images;

                bookData.previewPages = window.state.tempFiles.preview.length ? window.state.tempFiles.preview : (existing.previewPages || []);
                bookData.pdfContent = window.state.tempFiles.pdf ? window.state.tempFiles.pdf : (existing.pdfContent || '');

                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'books');
                    if(id) await updateDoc(doc(col, id), bookData);
                    else await addDoc(col, bookData);
                    alert('‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!'); 
                    toggleAdminTab('books');
                } catch(err) { alert("‡¶è‡¶∞‡¶∞: " + err.message); }
                finally { if(btn) { btn.disabled = false; btn.innerText = "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®"; } }
            }

            if(e.target.id === 'order-form') {
                e.preventDefault();
                const btn = document.getElementById('order-submit-btn');
                if(btn) { btn.disabled = true; btn.innerText = "‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç..."; }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                        bookId: document.getElementById('order-book-id').value,
                        name: document.getElementById('cust-name').value,
                        phone: document.getElementById('cust-phone').value,
                        address: document.getElementById('cust-address').value,
                        trxId: document.getElementById('cust-trx').value,
                        status: 'pending', timestamp: serverTimestamp()
                    });
                    alert('‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡•§');
                    closeOrderModal(); 
                    e.target.reset();
                } catch(err) { alert('‡¶´‡ßá‡¶á‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!'); }
                finally { if(btn) { btn.disabled = false; btn.innerText = "‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®"; } }
            }
        });

        init();
    </script>
</body>
</html>
